#!/bin/bash
# Script para probar el endpoint /api/trade

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "                   PRUEBA DEL ENDPOINT /api/trade"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar que el servidor estรก corriendo
if ! curl -s http://127.0.0.1:8000/health > /dev/null 2>&1; then
    echo "โ Error: El servidor no estรก corriendo en http://127.0.0.1:8000"
    echo "   Inicia el servidor con: make serve"
    exit 1
fi

echo "โ Servidor activo"
echo ""

# Prueba 1: Registrar una venta
echo "๐ Prueba 1: Registrar venta de 100 USD a 63.5 DOP/USD"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
RESPONSE=$(curl -X POST http://127.0.0.1:8000/api/trade \
  -H "Content-Type: application/json" \
  -d '{"action": "sell", "usd_amount": 100, "rate": 63.5, "fees": 25}' \
  -s -w "\n%{http_code}")

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

if [ "$HTTP_CODE" == "201" ]; then
    echo "โ Operaciรณn registrada exitosamente (HTTP 201)"
    echo "$BODY" | python3 -m json.tool
else
    echo "โ Error HTTP $HTTP_CODE"
    echo "$BODY"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Prueba 2: Registrar una compra (sin tasa, usa consenso)
echo "๐ Prueba 2: Registrar compra de 50 USD (usando tasa de consenso)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
RESPONSE2=$(curl -X POST http://127.0.0.1:8000/api/trade \
  -H "Content-Type: application/json" \
  -d '{"action": "buy", "usd_amount": 50}' \
  -s -w "\n%{http_code}")

HTTP_CODE2=$(echo "$RESPONSE2" | tail -n1)
BODY2=$(echo "$RESPONSE2" | head -n-1)

if [ "$HTTP_CODE2" == "201" ]; then
    echo "โ Operaciรณn registrada exitosamente (HTTP 201)"
    echo "$BODY2" | python3 -m json.tool
else
    echo "โ Error HTTP $HTTP_CODE2"
    echo "$BODY2"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Mostrar historial
echo "๐ Historial reciente de operaciones:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
curl -X POST http://127.0.0.1:8000/api/history \
  -s | python3 -m json.tool | head -50

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "                          PRUEBA COMPLETADA"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
